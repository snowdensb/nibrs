<!--

    Copyright 2016 SEARCH-The National Consortium for Justice Information and Statistics

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head th:fragment="headerfiles">
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="shortcut icon" href="#" />
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}" />
  <link rel="stylesheet" type="text/css" th:href="@{/webjars/datatables/1.10.19/css/dataTables.bootstrap4.min.css}" />
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.1.6/css/fixedHeader.bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" th:href="@{/webjars/font-awesome/5.2.0/css/all.css}" />
  <link href="https://cdn.jsdelivr.net/npm/gijgo@1.9.10/css/gijgo.min.css" rel="stylesheet" type="text/css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.min.css" rel="stylesheet" type="text/css" />
  <link href="https://cdn.datatables.net/buttons/1.5.6/css/buttons.dataTables.min.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" th:href="@{/css/style.css}" href="../../css/style.css" />
</head>
<body>
    <header th:fragment="header">
        <div class="banner mt-5 pt-1" th:fragment="banner" id="banner">
          <div class="text-white pl-3 align-middle pb-1">
            <img th:src="@{${brandImagePath}}" height="72px" /> 
            <span class="initials align-bottom" aria-hidden="true">NIBRS</span>
            <span class="fullname align-middle">Services Toolset</span>
          </div>
        </div>
	      <nav class="navbar navbar-expand-md bg-dark navbar-dark fixed-top fh-fixedHeader">
	        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
	          <span class="navbar-toggler-icon"></span>
	        </button>
	        <div class="collapse navbar-collapse" id="navbarCollapse">
	          <ul class="navbar-nav mr-auto text-white main-menu">
	            <li class="nav-item active">
	              <a class="nav-link" th:href="@{/home}" id="home">Home <span class="sr-only">(current)</span></a>
	            </li>
	            <li class="nav-item">
	              <a class="nav-link uploadToValidate" href="#" id="upload">PCT/Save for Summary Reports</a>
	            </li>
	            <li class="nav-item" th:if="${privateSummaryReportSite && !agencyMapping.empty}">
	              <a class="nav-link" href="#" id="errors">Errors</a>
	            </li>
	            <li class="nav-item">
	              <a class="nav-link" href="#" id="summaryReportInputForm" th:classappend="${agencyMapping.empty? 'no-data' : ''}">N2S/Summary Reports</a>
	            </li>
	            <li class="nav-item">
	              <a class="nav-link" href="#" id="incidents" th:classappend="${agencyMapping.empty? 'no-data' : ''}">Incident Record Search</a>
	            </li>
	            <li class="nav-item">
	              <a class="nav-link" href="#" id="incidentDeleteForm" th:classappend="${agencyMapping.empty? 'no-data' : ''}" th:unless="${privateSummaryReportSite}">Delete Incident Records</a>
	            </li>
	            <li class="nav-item" th:if="${allowSubmitToFbi && !agencyMapping.empty}">
	              <a class="nav-link" href="#" id="submitToFbi">Submit to FBI</a>
	            </li>
	            <li th:each="instance : ${externalLinksMapping}" class="nav-item">
							   <a class="nav-link external-link" th:href="${instance.value}" th:text="${instance.key}" target="_blank"></a>
							</li>
							<li class="nav-item dropdown" th:if="${aboutLinksMapping!=null && !aboutLinksMapping.empty}">
							   <a class="nav-link dropdown-toggle" href="#" id="dropdownAbout" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">About</a>
                 <div class="dropdown-menu" aria-labelledby="dropdownAbout">
                   <th:block th:each="aboutLink : ${aboutLinksMapping}">
                      <a class="dropdown-item"  th:href="${aboutLink.value}" th:text="${aboutLink.key}" target="_blank"></a>
                   </th:block>
                 </div>
							</li>
	          </ul>
	          
	          <ul class="navbar-nav flex-row ml-md-auto d-md-flex" sec:authorize="isAuthenticated()">
              <li class="nav-item dropdown">
	              <a class="nav-link dropdown-toggle text-light" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				          <i class="fas fa-user-circle fa-lg"></i>
		            </a>
			          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
			            <a class="dropdown-item disabled"><span class="small font-italic pr-2 text-secondary">Signed in as <strong th:text="${#authentication.getPrincipal().getUsername()}"></strong></span></a>
			            <div class="dropdown-divider"></div>
			            <a class="dropdown-item" href="https://nibrs.search.org/home"><span class="small font-italic pr-2">User Profile</span></a>
			            <div class="dropdown-divider"></div>
			            <a class="dropdown-item" th:href="@{/logout}"><span class="small font-italic pr-2">Sign Out</span> <i class="fas fa-sign-out-alt"></i></a>
			          </div>
              </li>
            </ul>
	        </div>
	      </nav>
      </header>
	    <p>Go to the next page to see fragments in action</p>
	    <footer class="footer" th:fragment="footer">
	      <div class="container-fluid" align="center">
	        <span>Questions? Email SEARCH at <a href="mailto:nibrs@search.org">nibrs@search.org</a></span>
	        <p class="text-muted">This Web site is funded through a grant from the Bureau of Justice Statistics, Office of Justice Programs, U.S. Department of Justice. Neither the U.S. Department of Justice nor any of its components operate, control, are responsible for, or necessarily endorse, this Web site (including, without limitation, its content, technical infrastructure, and policies, and any services or tools provided).</p>
	      </div>
	    </footer>
    
    <div th:fragment="javascripts">
   	    <!-- Optional JavaScript -->
	    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
		  <script th:src="@{/webjars/jquery/3.3.1/jquery.min.js}"></script>
		  <script th:src="@{/webjars/popper.js/1.14.4/dist/umd/popper.min.js}"></script>
      <script type="text/javascript" th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>
		  <script type="text/javascript" th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
	    <script type="text/javascript" th:src="@{/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js}"></script>
	    <script type="text/javascript" th:src="@{/webjars/datatables-fixedheader/3.1.6/js/dataTables.fixedHeader.js}"></script>
	    <script type="text/javascript" th:src="@{/webjars/datatables-responsive/2.2.3/js/dataTables.responsive.js}"></script>
	    <script type="text/javascript" th:src="@{/webjars/font-awesome/5.2.0/js/all.js}"></script>
	    <script src="https://cdn.jsdelivr.net/npm/gijgo@1.9.10/js/gijgo.min.js" type="text/javascript"></script>
			<!-- <script type="text/javascript" th:src="@{/webjars/jquery-maskedinput/1.4.0/jquery.maskedinput.js}"></script> --> 
			<script type="text/javascript" th:src="@{/js/plugins/jquery.mask.min.js}"></script> 
			<script type="text/javascript" th:src="@{/js/plugins/bootpopup.js}"></script> 
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.jquery.min.js"></script> 
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script> 
			<script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.10.19/sorting/datetime-moment.js"></script> 
			<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js"></script> 
			<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js"></script> 
			<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.print.min.js"></script> 
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script> 
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.12/pdfmake.min.js"></script> 
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.12/vfs_fonts.js"></script> 
	    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.colVis.min.js"></script> 
			<script th:inline="javascript">
				/*<![CDATA[*/
					var context = [[@{/}]];
					var securityEnabled = [[${securityEnabled}]]; 
					var inactivityTimeout = [[${inactivityTimeout}]]; 
					var inactivityTimeoutInSeconds = [[${inactivityTimeoutInSeconds}]]; 
				/*]]>*/
				var idleTime;
				var table;
				$(function(){
					if( securityEnabled && inactivityTimeout ){
					  ojbc.reloadPage();
		     		$('html').on('mousemove click mouseup mousedown keydown keypress keyup submit change mouseenter scroll resize dblclick', function () {
							clearTimeout(idleTime);
							ojbc.reloadPage();
 						});
		  		}
		   	      
          $(".navbar-nav .nav-link:not(.external-link)").on("click", function(){
						$(this).parent().siblings().removeClass('show');
						$(this).parent().addClass('active').siblings().removeClass('active');
						
						if (table !== undefined && table.fixedHeader !== undefined){
								table.fixedHeader.disable();
								$('html, body').animate({scrollTop:$('#banner').position().top}, 'slow');						
 	          }
          });
          
          $("#navbarCollapse").on('show.bs.collapse', function() {
              $('a.nav-link:not(.dropdown-toggle)').click(function() {
                  $("#navbarCollapse").collapse('hide');
              });
              $('a.dropdown-item').click(function() {
                $("#navbarCollapse").collapse('hide');
              });
          });
		          
					$('body').on('click', 'a#incidents:not(.no-data)', function() {   
						xhr = $.get(context + 'incidents/searchForm', function(data) {
						   $('#portalContent').html(data); 
						 }).fail(ojbc.displayFailMessage);
						return false; 
			        });
			    	  
					$('body').on('click', 'a.uploadToValidate', function() {   
						$(this).parent().toggleClass('show');
						
						xhr = $.get(context + 'files/upload', function(data) {
						   $('#portalContent').html(data); 
						 }).fail(ojbc.displayFailMessage);
						return false; 
	        });
			    	  
					$('body').on('click', 'a#errors', function() {   
						$(this).parent().toggleClass('show');
						xhr = $.get(context + 'precertErrors/searchForm', function(data) {
						   $('#portalContent').html(data); 
						 }).fail(ojbc.displayFailMessage);
						return false; 
					});
			    	  
					$('body').on('click', 'a#submitToFbi', function() {   
						xhr = $.get(context + 'submission/searchForm', function(data) {
						   $('#portalContent').html(data); 
						 }).fail(ojbc.displayFailMessage);
						return false; 
					});
					$('body').on('click', 'a#summaryReportInputForm:not(.no-data)', function() {   
						xhr = $.get(context + 'summaryReports/searchForm', function(data) {
						   $('#portalContent').html(data); 
						 }).fail(ojbc.displayFailMessage);
						return false; 
					});
			    	  
					$('body').on('click', 'a#incidentDeleteForm:not(.no-data)', function() {   
						xhr = $.get(context + 'incidents/incidentDeleteForm', function(data) {
						   $('#portalContent').html(data); 
						 }).fail(ojbc.displayFailMessage);
						return false; 
					});

					$('body').on('click', 'a.no-data', function() {
						bootpopup.alert("Data must be processed and saved using the PCT to enable this function.", "NO DATA AVAILABLE"); 
						return false; 
					});
					
          $('body').on('click', 'img.uploadToValidate', function() {   
               $("#upload").click();
          });

          $('body').on('click', 'img.summaryReportInputForm', function() {   
               $("a#summaryReportInputForm:not(.no-data)").click();
          });

					
					$(document).ajaxSend(function( event, jqxhr, settings ) {
						if (!settings.url.includes('files/uploadStatus')){
						  if( $(".ojbc-modal").is(':visible')){
								var visibleOjbcModal = $(".ojbc-modal:visible");
								var modalDialog = visibleOjbcModal.children(".modal-dialog"); 
								var loadingDiv = visibleOjbcModal.children(".modalIframeSpinner");
			                
/* 								console.log("modalDialog.height():" + modalDialog.height()); 
								console.log("modalDialog.height() + parseInt( modalDialog.css('margin-top'), 10):" + modalDialog.height() + parseInt( modalDialog.css("margin-top"), 10)); 
								console.log("modalDialog.css('margin-top'):" + modalDialog.css("margin-top")); 
								console.log("visibleOjbcModal.width():" + visibleOjbcModal.width()); 
 */								
                loadingDiv.css('height', modalDialog.height() + parseInt( modalDialog.css("margin-top"), 10));
								loadingDiv.css('width', visibleOjbcModal.width());
								
								loadingDiv.show();           
				          
							}
						  else if ($('#dropzone').is(':visible')){
							  $("#loadingFileAjaxPane").css({"display": "block"}); 
						  }
						  else {
							  console.log("showing loading Pane for " + settings.url); 
							  console.log("loadingAjaxPane exists: " + $("#loadingAjaxPane").length); 
								var loadingDiv =  $("#loadingAjaxPane");
								var portalContentDiv = $("#portalContent");
								
								loadingDiv.css('height',portalContentDiv.height() + 20);
								loadingDiv.css('width', portalContentDiv.width());
							  $("#loadingAjaxPane").show();           
						  }        
	       	  }
					}).ajaxStop(function() {
            $('#loadingText').addClass("d-none");
						$("#loadingAjaxPane").hide();                
						$(".modalIframeSpinner").hide();
						$("#loadingFileAjaxPane").css({"display": "none"});                
            $("#divSpinner").hide();;           
					});
		 	          
	        $('[data-toggle="popover"]').popover(); 
		 	          
				});
			      
	      ojbc = {
	     	    handleEsc:function(){
	     	        $("body").on("keyup", function(event){
	     	           if ( event.keyCode == 27 ) {
	     	             event.preventDefault();
	     	             event.stopPropagation();
	     	             console.log("xhr is null:" +  xhr===null);
	     	             if(xhr && xhr.readyState != 4){
	     	               xhr.textStatus="aborted"; 
	     	               xhr.abort();
	     	             }
	     	         }
	     	        }); 
	     	     },
	     	     
	         displayFailMessage : function(jqXHR, textStatus, errorThrown) {
	           if (jqXHR.status == 500) {
 	             bootpopup({
	            	    title: "Error",
	            	    content: [
	            	        'An error occurred while processing your request. Please contact SEARCH at <a href="mailto:nibrs@search.org">nibrs@search.org</a> or try again later.'
	            	        ],
	            	    close: function(data,e) {}
	            	});
	           } else if (jqXHR.status == 0) {
	             if (jqXHR.textStatus != "aborted"){
	               window.location.reload();
	             }
	           } else if (jqXHR.status == 403) {
	              bootpopup.alert("Access is denied. Please check if you have the access right for the item.", "Error");
	            } else {
	            	bootpopup.alert("Unable to talk to Server.  Please try again later.", "Error");
	           }
	        }, 
	        
	        reloadPage: function() {
	            clearTimeout(idleTime);
	            idleTime = setTimeout(function () {
	                window.location.assign(context + "logout");
	            }, inactivityTimeoutInSeconds * 1000);
	        }
	      };
      </script>
	  </div>		
  </body>
</html>